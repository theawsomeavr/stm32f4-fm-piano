#include <leds.h>
#include <stm32f4xx.h>
#include <string.h>

static uint8_t led_buffer[LED_COUNT * 9 + 2];

static const uint8_t led_codes[256][3] = {
    {0b10010010, 0b01001001, 0b00100100}, {0b10010010, 0b01001001, 0b00100110}, {0b10010010, 0b01001001, 0b00110100}, {0b10010010, 0b01001001, 0b00110110},
    {0b10010010, 0b01001001, 0b10100100}, {0b10010010, 0b01001001, 0b10100110}, {0b10010010, 0b01001001, 0b10110100}, {0b10010010, 0b01001001, 0b10110110},
    {0b10010010, 0b01001101, 0b00100100}, {0b10010010, 0b01001101, 0b00100110}, {0b10010010, 0b01001101, 0b00110100}, {0b10010010, 0b01001101, 0b00110110},
    {0b10010010, 0b01001101, 0b10100100}, {0b10010010, 0b01001101, 0b10100110}, {0b10010010, 0b01001101, 0b10110100}, {0b10010010, 0b01001101, 0b10110110},
    {0b10010010, 0b01101001, 0b00100100}, {0b10010010, 0b01101001, 0b00100110}, {0b10010010, 0b01101001, 0b00110100}, {0b10010010, 0b01101001, 0b00110110},
    {0b10010010, 0b01101001, 0b10100100}, {0b10010010, 0b01101001, 0b10100110}, {0b10010010, 0b01101001, 0b10110100}, {0b10010010, 0b01101001, 0b10110110},
    {0b10010010, 0b01101101, 0b00100100}, {0b10010010, 0b01101101, 0b00100110}, {0b10010010, 0b01101101, 0b00110100}, {0b10010010, 0b01101101, 0b00110110},
    {0b10010010, 0b01101101, 0b10100100}, {0b10010010, 0b01101101, 0b10100110}, {0b10010010, 0b01101101, 0b10110100}, {0b10010010, 0b01101101, 0b10110110},
    {0b10010011, 0b01001001, 0b00100100}, {0b10010011, 0b01001001, 0b00100110}, {0b10010011, 0b01001001, 0b00110100}, {0b10010011, 0b01001001, 0b00110110},
    {0b10010011, 0b01001001, 0b10100100}, {0b10010011, 0b01001001, 0b10100110}, {0b10010011, 0b01001001, 0b10110100}, {0b10010011, 0b01001001, 0b10110110},
    {0b10010011, 0b01001101, 0b00100100}, {0b10010011, 0b01001101, 0b00100110}, {0b10010011, 0b01001101, 0b00110100}, {0b10010011, 0b01001101, 0b00110110},
    {0b10010011, 0b01001101, 0b10100100}, {0b10010011, 0b01001101, 0b10100110}, {0b10010011, 0b01001101, 0b10110100}, {0b10010011, 0b01001101, 0b10110110},
    {0b10010011, 0b01101001, 0b00100100}, {0b10010011, 0b01101001, 0b00100110}, {0b10010011, 0b01101001, 0b00110100}, {0b10010011, 0b01101001, 0b00110110},
    {0b10010011, 0b01101001, 0b10100100}, {0b10010011, 0b01101001, 0b10100110}, {0b10010011, 0b01101001, 0b10110100}, {0b10010011, 0b01101001, 0b10110110},
    {0b10010011, 0b01101101, 0b00100100}, {0b10010011, 0b01101101, 0b00100110}, {0b10010011, 0b01101101, 0b00110100}, {0b10010011, 0b01101101, 0b00110110},
    {0b10010011, 0b01101101, 0b10100100}, {0b10010011, 0b01101101, 0b10100110}, {0b10010011, 0b01101101, 0b10110100}, {0b10010011, 0b01101101, 0b10110110},
    {0b10011010, 0b01001001, 0b00100100}, {0b10011010, 0b01001001, 0b00100110}, {0b10011010, 0b01001001, 0b00110100}, {0b10011010, 0b01001001, 0b00110110},
    {0b10011010, 0b01001001, 0b10100100}, {0b10011010, 0b01001001, 0b10100110}, {0b10011010, 0b01001001, 0b10110100}, {0b10011010, 0b01001001, 0b10110110},
    {0b10011010, 0b01001101, 0b00100100}, {0b10011010, 0b01001101, 0b00100110}, {0b10011010, 0b01001101, 0b00110100}, {0b10011010, 0b01001101, 0b00110110},
    {0b10011010, 0b01001101, 0b10100100}, {0b10011010, 0b01001101, 0b10100110}, {0b10011010, 0b01001101, 0b10110100}, {0b10011010, 0b01001101, 0b10110110},
    {0b10011010, 0b01101001, 0b00100100}, {0b10011010, 0b01101001, 0b00100110}, {0b10011010, 0b01101001, 0b00110100}, {0b10011010, 0b01101001, 0b00110110},
    {0b10011010, 0b01101001, 0b10100100}, {0b10011010, 0b01101001, 0b10100110}, {0b10011010, 0b01101001, 0b10110100}, {0b10011010, 0b01101001, 0b10110110},
    {0b10011010, 0b01101101, 0b00100100}, {0b10011010, 0b01101101, 0b00100110}, {0b10011010, 0b01101101, 0b00110100}, {0b10011010, 0b01101101, 0b00110110},
    {0b10011010, 0b01101101, 0b10100100}, {0b10011010, 0b01101101, 0b10100110}, {0b10011010, 0b01101101, 0b10110100}, {0b10011010, 0b01101101, 0b10110110},
    {0b10011011, 0b01001001, 0b00100100}, {0b10011011, 0b01001001, 0b00100110}, {0b10011011, 0b01001001, 0b00110100}, {0b10011011, 0b01001001, 0b00110110},
    {0b10011011, 0b01001001, 0b10100100}, {0b10011011, 0b01001001, 0b10100110}, {0b10011011, 0b01001001, 0b10110100}, {0b10011011, 0b01001001, 0b10110110},
    {0b10011011, 0b01001101, 0b00100100}, {0b10011011, 0b01001101, 0b00100110}, {0b10011011, 0b01001101, 0b00110100}, {0b10011011, 0b01001101, 0b00110110},
    {0b10011011, 0b01001101, 0b10100100}, {0b10011011, 0b01001101, 0b10100110}, {0b10011011, 0b01001101, 0b10110100}, {0b10011011, 0b01001101, 0b10110110},
    {0b10011011, 0b01101001, 0b00100100}, {0b10011011, 0b01101001, 0b00100110}, {0b10011011, 0b01101001, 0b00110100}, {0b10011011, 0b01101001, 0b00110110},
    {0b10011011, 0b01101001, 0b10100100}, {0b10011011, 0b01101001, 0b10100110}, {0b10011011, 0b01101001, 0b10110100}, {0b10011011, 0b01101001, 0b10110110},
    {0b10011011, 0b01101101, 0b00100100}, {0b10011011, 0b01101101, 0b00100110}, {0b10011011, 0b01101101, 0b00110100}, {0b10011011, 0b01101101, 0b00110110},
    {0b10011011, 0b01101101, 0b10100100}, {0b10011011, 0b01101101, 0b10100110}, {0b10011011, 0b01101101, 0b10110100}, {0b10011011, 0b01101101, 0b10110110},
    {0b11010010, 0b01001001, 0b00100100}, {0b11010010, 0b01001001, 0b00100110}, {0b11010010, 0b01001001, 0b00110100}, {0b11010010, 0b01001001, 0b00110110},
    {0b11010010, 0b01001001, 0b10100100}, {0b11010010, 0b01001001, 0b10100110}, {0b11010010, 0b01001001, 0b10110100}, {0b11010010, 0b01001001, 0b10110110},
    {0b11010010, 0b01001101, 0b00100100}, {0b11010010, 0b01001101, 0b00100110}, {0b11010010, 0b01001101, 0b00110100}, {0b11010010, 0b01001101, 0b00110110},
    {0b11010010, 0b01001101, 0b10100100}, {0b11010010, 0b01001101, 0b10100110}, {0b11010010, 0b01001101, 0b10110100}, {0b11010010, 0b01001101, 0b10110110},
    {0b11010010, 0b01101001, 0b00100100}, {0b11010010, 0b01101001, 0b00100110}, {0b11010010, 0b01101001, 0b00110100}, {0b11010010, 0b01101001, 0b00110110},
    {0b11010010, 0b01101001, 0b10100100}, {0b11010010, 0b01101001, 0b10100110}, {0b11010010, 0b01101001, 0b10110100}, {0b11010010, 0b01101001, 0b10110110},
    {0b11010010, 0b01101101, 0b00100100}, {0b11010010, 0b01101101, 0b00100110}, {0b11010010, 0b01101101, 0b00110100}, {0b11010010, 0b01101101, 0b00110110},
    {0b11010010, 0b01101101, 0b10100100}, {0b11010010, 0b01101101, 0b10100110}, {0b11010010, 0b01101101, 0b10110100}, {0b11010010, 0b01101101, 0b10110110},
    {0b11010011, 0b01001001, 0b00100100}, {0b11010011, 0b01001001, 0b00100110}, {0b11010011, 0b01001001, 0b00110100}, {0b11010011, 0b01001001, 0b00110110},
    {0b11010011, 0b01001001, 0b10100100}, {0b11010011, 0b01001001, 0b10100110}, {0b11010011, 0b01001001, 0b10110100}, {0b11010011, 0b01001001, 0b10110110},
    {0b11010011, 0b01001101, 0b00100100}, {0b11010011, 0b01001101, 0b00100110}, {0b11010011, 0b01001101, 0b00110100}, {0b11010011, 0b01001101, 0b00110110},
    {0b11010011, 0b01001101, 0b10100100}, {0b11010011, 0b01001101, 0b10100110}, {0b11010011, 0b01001101, 0b10110100}, {0b11010011, 0b01001101, 0b10110110},
    {0b11010011, 0b01101001, 0b00100100}, {0b11010011, 0b01101001, 0b00100110}, {0b11010011, 0b01101001, 0b00110100}, {0b11010011, 0b01101001, 0b00110110},
    {0b11010011, 0b01101001, 0b10100100}, {0b11010011, 0b01101001, 0b10100110}, {0b11010011, 0b01101001, 0b10110100}, {0b11010011, 0b01101001, 0b10110110},
    {0b11010011, 0b01101101, 0b00100100}, {0b11010011, 0b01101101, 0b00100110}, {0b11010011, 0b01101101, 0b00110100}, {0b11010011, 0b01101101, 0b00110110},
    {0b11010011, 0b01101101, 0b10100100}, {0b11010011, 0b01101101, 0b10100110}, {0b11010011, 0b01101101, 0b10110100}, {0b11010011, 0b01101101, 0b10110110},
    {0b11011010, 0b01001001, 0b00100100}, {0b11011010, 0b01001001, 0b00100110}, {0b11011010, 0b01001001, 0b00110100}, {0b11011010, 0b01001001, 0b00110110},
    {0b11011010, 0b01001001, 0b10100100}, {0b11011010, 0b01001001, 0b10100110}, {0b11011010, 0b01001001, 0b10110100}, {0b11011010, 0b01001001, 0b10110110},
    {0b11011010, 0b01001101, 0b00100100}, {0b11011010, 0b01001101, 0b00100110}, {0b11011010, 0b01001101, 0b00110100}, {0b11011010, 0b01001101, 0b00110110},
    {0b11011010, 0b01001101, 0b10100100}, {0b11011010, 0b01001101, 0b10100110}, {0b11011010, 0b01001101, 0b10110100}, {0b11011010, 0b01001101, 0b10110110},
    {0b11011010, 0b01101001, 0b00100100}, {0b11011010, 0b01101001, 0b00100110}, {0b11011010, 0b01101001, 0b00110100}, {0b11011010, 0b01101001, 0b00110110},
    {0b11011010, 0b01101001, 0b10100100}, {0b11011010, 0b01101001, 0b10100110}, {0b11011010, 0b01101001, 0b10110100}, {0b11011010, 0b01101001, 0b10110110},
    {0b11011010, 0b01101101, 0b00100100}, {0b11011010, 0b01101101, 0b00100110}, {0b11011010, 0b01101101, 0b00110100}, {0b11011010, 0b01101101, 0b00110110},
    {0b11011010, 0b01101101, 0b10100100}, {0b11011010, 0b01101101, 0b10100110}, {0b11011010, 0b01101101, 0b10110100}, {0b11011010, 0b01101101, 0b10110110},
    {0b11011011, 0b01001001, 0b00100100}, {0b11011011, 0b01001001, 0b00100110}, {0b11011011, 0b01001001, 0b00110100}, {0b11011011, 0b01001001, 0b00110110},
    {0b11011011, 0b01001001, 0b10100100}, {0b11011011, 0b01001001, 0b10100110}, {0b11011011, 0b01001001, 0b10110100}, {0b11011011, 0b01001001, 0b10110110},
    {0b11011011, 0b01001101, 0b00100100}, {0b11011011, 0b01001101, 0b00100110}, {0b11011011, 0b01001101, 0b00110100}, {0b11011011, 0b01001101, 0b00110110},
    {0b11011011, 0b01001101, 0b10100100}, {0b11011011, 0b01001101, 0b10100110}, {0b11011011, 0b01001101, 0b10110100}, {0b11011011, 0b01001101, 0b10110110},
    {0b11011011, 0b01101001, 0b00100100}, {0b11011011, 0b01101001, 0b00100110}, {0b11011011, 0b01101001, 0b00110100}, {0b11011011, 0b01101001, 0b00110110},
    {0b11011011, 0b01101001, 0b10100100}, {0b11011011, 0b01101001, 0b10100110}, {0b11011011, 0b01101001, 0b10110100}, {0b11011011, 0b01101001, 0b10110110},
    {0b11011011, 0b01101101, 0b00100100}, {0b11011011, 0b01101101, 0b00100110}, {0b11011011, 0b01101101, 0b00110100}, {0b11011011, 0b01101101, 0b00110110},
    {0b11011011, 0b01101101, 0b10100100}, {0b11011011, 0b01101101, 0b10100110}, {0b11011011, 0b01101101, 0b10110100}, {0b11011011, 0b01101101, 0b10110110},
};

LedColor leds_hue(float hue){
    LedColor c = {.r = 0, .g = 0, .b = 0};
    return c;
}

LedColor leds_color(float r, float g, float b){
    LedColor c = {.r = r * 255, .g = g * 255, .b = b * 255};
    return c;
}

void leds_init(){
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOBEN | RCC_AHB1ENR_DMA2EN;
    RCC->APB2ENR |= RCC_APB2ENR_SPI5EN;

    //PB8 to alternate function
    GPIOB->MODER = (GPIOB->MODER & ~GPIO_MODER_MODER8) | (0b10 << GPIO_MODER_MODER8_Pos);
    //AF06 for PB8 (SPI5 tx)
    GPIOB->AFR[1] = (GPIOB->AFR[1] & ~GPIO_AFRH_AFSEL8) | (6 << GPIO_AFRH_AFSEL8_Pos);

    //SPI in unidirection mode, prescalar of 32
    SPI5->CR1 = SPI_CR1_BIDIMODE | SPI_CR1_BIDIOE | (0b100 << SPI_CR1_BR_Pos) | SPI_CR1_MSTR | SPI_CR1_SSI | SPI_CR1_SSM;
    SPI5->CR1 |= SPI_CR1_SPE;
    SPI5->CR2 |= SPI_CR2_TXDMAEN; //Enable SPI DMA mode
    leds_clear();
}

void leds_clear(){
    for(uint32_t i = 0; i != LED_COUNT * 3; i++)memcpy(led_buffer + i * 3, led_codes[0], 3);
    led_buffer[LED_COUNT * 9 + 0] = 0;
    led_buffer[LED_COUNT * 9 + 1] = 0;
}

void leds_set(LedColor color, uint8_t led){
    uint8_t *dest = led_buffer + led * 9;
    for(uint8_t i = 0; i != 3; i++){
        dest[i]     = led_codes[color.g][i];
        dest[i + 3] = led_codes[color.r][i];
        dest[i + 6] = led_codes[color.b][i];
    }
    led_buffer[LED_COUNT * 9 + 0] = 0;
    led_buffer[LED_COUNT * 9 + 1] = 0;
}

void leds_show(){
    DMA2->HIFCR = DMA_HIFCR_CTCIF5;

    //Channel 5 (SPI5 TX); 8 bit size; Mem -> Perif
    DMA2_Stream5->CR = (5 << DMA_SxCR_CHSEL_Pos)
                       | DMA_SxCR_MINC
                       | (0b00 << DMA_SxCR_MSIZE_Pos)
                       | (0b10 << DMA_SxCR_PL_Pos)
                       | (0b01 << DMA_SxCR_DIR_Pos);

    DMA2_Stream5->NDTR = 9 * LED_COUNT + 2;
    DMA2_Stream5->M0AR = (uint32_t)led_buffer;
    DMA2_Stream5->PAR  = (uint32_t)&SPI5->DR;

    DMA2_Stream5->CR |= DMA_SxCR_EN;
}
